<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>porepy.models.constitutive_laws &mdash; PorePy 1.6.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="canonical" href="https://pmgbergen.github.io/porepy/_modules/porepy/models/constitutive_laws.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >
            <a href="../../../index.html" class="icon icon-home"> PorePy
          </a>
              <div class="version">
                1.6.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docsrc/howto/howto-docstring.html">1. How-To docstring</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docsrc/porepy/modules.html">porepy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../docsrc/porepy/porepy.html">porepy package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.html">porepy.fracs package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.fracture.html">porepy.fracs.fracture module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.fracture_importer.html">porepy.fracs.fracture_importer module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.fracture_network_2d.html">porepy.fracs.fracture_network_2d module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.fracture_network_3d.html">porepy.fracs.fracture_network_3d module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.gmsh_interface.html">porepy.fracs.gmsh_interface module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.line_fracture.html">porepy.fracs.line_fracture module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.meshing.html">porepy.fracs.meshing module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.msh_2_grid.html">porepy.fracs.msh_2_grid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.non_conforming.html">porepy.fracs.non_conforming module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.plane_fracture.html">porepy.fracs.plane_fracture module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.simplex.html">porepy.fracs.simplex module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.split_grid.html">porepy.fracs.split_grid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.structured.html">porepy.fracs.structured module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.tools.html">porepy.fracs.tools module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.utils.html">porepy.fracs.utils module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.fracs.wells_3d.html">porepy.fracs.wells_3d module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.html">porepy.geometry package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.bounding_box.html">porepy.geometry.bounding_box module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.constrain_geometry.html">porepy.geometry.constrain_geometry module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.distances.html">porepy.geometry.distances module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.geometry_property_checks.html">porepy.geometry.geometry_property_checks module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.half_space.html">porepy.geometry.half_space module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.intersections.html">porepy.geometry.intersections module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.map_geometry.html">porepy.geometry.map_geometry module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.geometry.point_in_polyhedron_test.html">porepy.geometry.point_in_polyhedron_test module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.html">porepy.grids package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.standard_grids.html">porepy.grids.standard_grids package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.boundary_grid.html">porepy.grids.boundary_grid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.coarsening.html">porepy.grids.coarsening module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.grid.html">porepy.grids.grid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.grid_extrusion.html">porepy.grids.grid_extrusion module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.match_grids.html">porepy.grids.match_grids module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.md_grid.html">porepy.grids.md_grid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.mortar_grid.html">porepy.grids.mortar_grid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.partition.html">porepy.grids.partition module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.point_grid.html">porepy.grids.point_grid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.refinement.html">porepy.grids.refinement module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.simplex.html">porepy.grids.simplex module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.grids.structured.html">porepy.grids.structured module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.html">porepy.models package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.verification_setups.html">porepy.models.verification_setups package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.abstract_equations.html">porepy.models.abstract_equations module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.abstract_model.html">porepy.models.abstract_model module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html">porepy.models.constitutive_laws module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.contact_mechanics_biot_model.html">porepy.models.contact_mechanics_biot_model module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.contact_mechanics_model.html">porepy.models.contact_mechanics_model module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.energy_balance.html">porepy.models.energy_balance module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.fluid_mass_balance.html">porepy.models.fluid_mass_balance module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.geometry.html">porepy.models.geometry module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.incompressible_flow_model.html">porepy.models.incompressible_flow_model module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.mass_and_energy_balance.html">porepy.models.mass_and_energy_balance module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.material_constants.html">porepy.models.material_constants module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.momentum_balance.html">porepy.models.momentum_balance module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.poromechanics.html">porepy.models.poromechanics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.run_models.html">porepy.models.run_models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.slightly_compressible_flow_model.html">porepy.models.slightly_compressible_flow_model module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.solution_strategy.html">porepy.models.solution_strategy module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.thermoporomechanics.html">porepy.models.thermoporomechanics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.thm_model.html">porepy.models.thm_model module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.models.units.html">porepy.models.units module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.html">porepy.numerics package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.ad.html">porepy.numerics.ad package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.fem.html">porepy.numerics.fem package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.fracture_deformation.html">porepy.numerics.fracture_deformation package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.fv.html">porepy.numerics.fv package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.interface_laws.html">porepy.numerics.interface_laws package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.linalg.html">porepy.numerics.linalg package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.mixed_dim.html">porepy.numerics.mixed_dim package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.nonlinear.html">porepy.numerics.nonlinear package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.solvers.html">porepy.numerics.solvers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.vem.html">porepy.numerics.vem package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.discretization.html">porepy.numerics.discretization module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.displacement_correlation.html">porepy.numerics.displacement_correlation module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.linear_solvers.html">porepy.numerics.linear_solvers module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.numerics.time_step_control.html">porepy.numerics.time_step_control module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.params.html">porepy.params package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.params.bc.html">porepy.params.bc module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.params.data.html">porepy.params.data module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.params.fluid.html">porepy.params.fluid module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.params.parameter_dictionaries.html">porepy.params.parameter_dictionaries module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.params.rock.html">porepy.params.rock module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.params.tensor.html">porepy.params.tensor module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.html">porepy.utils package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.derived_discretizations.html">porepy.utils.derived_discretizations package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.accumarray.html">porepy.utils.accumarray module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.adtree.html">porepy.utils.adtree module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.array_operations.html">porepy.utils.array_operations module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.common_constants.html">porepy.utils.common_constants module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.default_domains.html">porepy.utils.default_domains module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.error.html">porepy.utils.error module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.graph.html">porepy.utils.graph module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.grid_utils.html">porepy.utils.grid_utils module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.interpolation_tables.html">porepy.utils.interpolation_tables module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.mcolon.html">porepy.utils.mcolon module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.permutations.html">porepy.utils.permutations module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.porepy_types.html">porepy.utils.porepy_types module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.setmembership.html">porepy.utils.setmembership module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.sort_points.html">porepy.utils.sort_points module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.tags.html">porepy.utils.tags module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.utils.tangential_normal_projection.html">porepy.utils.tangential_normal_projection module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../docsrc/porepy/porepy.viz.html">porepy.viz package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.viz.data_saving_model_mixin.html">porepy.viz.data_saving_model_mixin module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.viz.exporter.html">porepy.viz.exporter module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.viz.fracture_visualization.html">porepy.viz.fracture_visualization module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../docsrc/porepy/porepy.viz.plot_grid.html">porepy.viz.plot_grid module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PorePy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">porepy.models.constitutive_laws</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for porepy.models.constitutive_laws</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Library of constitutive equations.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">porepy</span> <span class="k">as</span> <span class="nn">pp</span>

<span class="n">number</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">number</span>
<span class="n">Scalar</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span>


<div class="viewcode-block" id="DimensionReduction"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DimensionReduction">[docs]</a><span class="k">class</span> <span class="nc">DimensionReduction</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Apertures and specific volumes.&quot;&quot;&quot;</span>

    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DimensionReduction.grid_aperture"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DimensionReduction.grid_aperture">[docs]</a>    <span class="k">def</span> <span class="nf">grid_aperture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the aperture of a single grid.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            grid: Grid for which to compute the aperture.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Aperture for each cell in the grid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">num_cells</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">dim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
            <span class="n">aperture</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">residual_aperture</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">aperture</span></div>

<div class="viewcode-block" id="DimensionReduction.aperture"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DimensionReduction.aperture">[docs]</a>    <span class="k">def</span> <span class="nf">aperture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aperture [m].</span>

<span class="sd">        Aperture is a characteristic thickness of a cell, with units [m].</span>
<span class="sd">        1 in matrix, thickness of fractures and &quot;side length&quot; of cross-sectional</span>
<span class="sd">        area/volume (or &quot;specific volume&quot;) for intersections of dimension 1 and 0.</span>

<span class="sd">        See also:</span>
<span class="sd">            :meth:specific_volume.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Ad operator representing the aperture for each cell in each subdomain.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">SubdomainProjections</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># The implementation here is not perfect, but it seems to be what is needed</span>
        <span class="c1"># to make the Ad framework happy: Build the global array by looping over</span>
        <span class="c1"># subdomains and add the local contributions.</span>
        <span class="c1"># Note that the aperture is an array (in the Ad sense) not a matrix, thus there</span>
        <span class="c1"># is no risk of the number of columns being wrong (as there would be if we</span>
        <span class="c1"># were to wrap the aperture as an Ad matrix).</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdomains</span><span class="p">):</span>
            <span class="c1"># First make the local aperture array.</span>
            <span class="n">a_loc</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_aperture</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
            <span class="c1"># Expand to a global array.</span>
            <span class="n">a_glob</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">([</span><span class="n">sd</span><span class="p">])</span> <span class="o">*</span> <span class="n">a_loc</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">apertures</span> <span class="o">=</span> <span class="n">a_glob</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">apertures</span> <span class="o">+=</span> <span class="n">a_glob</span>
        <span class="n">apertures</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;aperture&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">apertures</span></div>

<div class="viewcode-block" id="DimensionReduction.specific_volume"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DimensionReduction.specific_volume">[docs]</a>    <span class="k">def</span> <span class="nf">specific_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Specific volume [m^(nd-d)]</span>

<span class="sd">        Aperture is a characteristic thickness of a cell, with units [m].</span>
<span class="sd">        1 in matrix, thickness of fractures and &quot;side length&quot; of cross-sectional</span>
<span class="sd">        area/volume (or &quot;specific volume&quot;) for intersections of dimension 1 and 0.</span>

<span class="sd">        See also:</span>
<span class="sd">            :meth:aperture.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Specific volume for each cell.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Compute specific volume as the cross-sectional area/volume</span>
        <span class="c1"># of the cell, i.e. raise to the power nd-dim</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">SubdomainProjections</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">v</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Loop over dimensions, and add the contribution from each subdomain within</span>
        <span class="c1"># that dimension.</span>
        <span class="c1"># NOTE: The loop is reversed, to ensure that the subdomains are processed in the</span>
        <span class="c1"># same order as will be returned by an iteration over the subdomains of the</span>
        <span class="c1"># mixed-dimensional grid. If the order in input argument subdomains is</span>
        <span class="c1"># different, the result will likely be wrong.</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sd_dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span> <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">dim</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sd_dim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">a_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="p">(</span><span class="n">sd_dim</span><span class="p">)</span>
            <span class="n">v_loc</span> <span class="o">=</span> <span class="n">a_loc</span> <span class="o">**</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span>
            <span class="n">v_glob</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">(</span><span class="n">sd_dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_loc</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v_glob</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">v_glob</span>

        <span class="c1"># If we found no subdomains, we may have a problem. Possibly we should just</span>
        <span class="c1"># return a void Operator.</span>
        <span class="k">assert</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No subdomains found&quot;</span>

        <span class="n">v</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;specific_volume&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">v</span></div></div>


<div class="viewcode-block" id="DisplacementJumpAperture"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DisplacementJumpAperture">[docs]</a><span class="k">class</span> <span class="nc">DisplacementJumpAperture</span><span class="p">(</span><span class="n">DimensionReduction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fracture aperture from displacement jump.&quot;&quot;&quot;</span>

    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subdomains_to_interfaces</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from subdomains to the adjacent interfaces. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_to_subdomains</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from interfaces to the adjacent subdomains. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal_component</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Operator giving the normal component of vectors. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.models.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">displacement_jump</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Operator giving the displacement jump on fracture grids. Normally defined in a</span>
<span class="sd">    mixin instance of :class:`~porepy.models.models.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdg</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">MixedDimensionalGrid</span>
    <span class="sd">&quot;&quot;&quot;Mixed dimensional grid for the current model. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">equation_system</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">EquationSystem</span>
    <span class="sd">&quot;&quot;&quot;EquationSystem object for the current model. Normally defined in a mixin class</span>
<span class="sd">    defining the solution strategy.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DisplacementJumpAperture.residual_aperture"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DisplacementJumpAperture.residual_aperture">[docs]</a>    <span class="k">def</span> <span class="nf">residual_aperture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Scalar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Residual aperture [m].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids. Not used, but included for consistency</span>
<span class="sd">                with other methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Ad operator representing the resdiual aperture for the grids. The value is</span>
<span class="sd">            constant for each grid, and is the same for all cells in the grid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">residual_aperture</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;residual_aperture&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DisplacementJumpAperture.aperture"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DisplacementJumpAperture.aperture">[docs]</a>    <span class="k">def</span> <span class="nf">aperture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aperture [m].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing apertures.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For now, assume no intersections</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">SubdomainProjections</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Subdomains of the top dimension</span>
        <span class="n">nd_subdomains</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span> <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">]</span>

        <span class="n">num_cells_nd_subdomains</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">sd</span><span class="o">.</span><span class="n">num_cells</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">nd_subdomains</span><span class="p">])</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_cells_nd_subdomains</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;one&quot;</span><span class="p">)</span>
        <span class="c1"># Start with nd, where aperture is one.</span>
        <span class="n">apertures</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">(</span><span class="n">nd_subdomains</span><span class="p">)</span> <span class="o">*</span> <span class="n">one</span>

        <span class="c1"># NOTE: The loop is reversed, to ensure that the subdomains are processed in the</span>
        <span class="c1"># same order as will be returned by an iteration over the subdomains of the</span>
        <span class="c1"># mixed-dimensional grid. If the order in input argument subdomains is</span>
        <span class="c1"># different, the result will likely be wrong.</span>
        <span class="c1"># Only consider subdomains of lower dimension, there is no aperture for the top</span>
        <span class="c1"># dimension.</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">subdomains_of_dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span> <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">dim</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdomains_of_dim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Fractures. Get displacement jump</span>
                <span class="n">normal_jump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal_component</span><span class="p">(</span>
                    <span class="n">subdomains_of_dim</span>
                <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement_jump</span><span class="p">(</span><span class="n">subdomains_of_dim</span><span class="p">)</span>
                <span class="c1"># The jump should be bounded below by gap function. This is not</span>
                <span class="c1"># guaranteed in the non-converged state. As this (especially</span>
                <span class="c1"># non-positive values) may give significant trouble in the aperture.</span>
                <span class="c1"># Insert safeguard by taking maximum of the jump and a residual</span>
                <span class="c1"># aperture.</span>
                <span class="n">f_max</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="s2">&quot;maximum_function&quot;</span><span class="p">)</span>

                <span class="n">a_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_aperture</span><span class="p">(</span><span class="n">subdomains_of_dim</span><span class="p">)</span>
                <span class="n">apertures_of_dim</span> <span class="o">=</span> <span class="n">f_max</span><span class="p">(</span><span class="n">normal_jump</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">)</span>
                <span class="n">apertures_of_dim</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;aperture_maximum_function&quot;</span><span class="p">)</span>
                <span class="n">apertures</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">apertures</span>
                    <span class="o">+</span> <span class="n">projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">(</span><span class="n">subdomains_of_dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">apertures_of_dim</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Intersection aperture is average of apertures of intersecting</span>
                <span class="c1"># fractures.</span>
                <span class="n">interfaces_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains_of_dim</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># Only consider interfaces of the current dimension, i.e. those related</span>
                <span class="c1"># to higher-dimensional neighbors.</span>
                <span class="n">interfaces_dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">intf</span> <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">interfaces_dim</span> <span class="k">if</span> <span class="n">intf</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">dim</span><span class="p">]</span>
                <span class="c1"># Get the higher-dimensional neighbors.</span>
                <span class="n">parent_subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces_to_subdomains</span><span class="p">(</span><span class="n">interfaces_dim</span><span class="p">)</span>
                <span class="c1"># Only consider the higher-dimensional neighbors, i.e. disregard the</span>
                <span class="c1"># intersections with the current dimension.</span>
                <span class="n">parent_subdomains</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">sd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">parent_subdomains</span> <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">]</span>
                <span class="c1"># Create projection operator between the subdomains involved in the</span>
                <span class="c1"># computation, i.e. the current dimension and the higher-dimensional</span>
                <span class="c1"># neighbors.</span>
                <span class="n">mortar_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains_of_dim</span> <span class="o">+</span> <span class="n">parent_subdomains</span><span class="p">,</span> <span class="n">interfaces_dim</span>
                <span class="p">)</span>
                <span class="c1"># Get the apertures of the higher-dimensional neighbors.</span>
                <span class="n">parent_apertures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="p">(</span><span class="n">parent_subdomains</span><span class="p">)</span>
                <span class="c1"># Projection from parents to intersections via the mortar grid.</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">parent_subdomains</span><span class="p">)</span>
                <span class="n">parent_cells_to_intersection_cells</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mortar_projection</span><span class="o">.</span><span class="n">mortar_to_secondary_avg</span>
                    <span class="o">*</span> <span class="n">mortar_projection</span><span class="o">.</span><span class="n">primary_to_mortar_avg</span>
                    <span class="o">*</span> <span class="n">trace</span><span class="o">.</span><span class="n">trace</span>
                <span class="p">)</span>
                <span class="c1"># Average weights are the number of cells in the parent subdomains</span>
                <span class="c1"># contributing to each intersection cells.</span>
                <span class="n">average_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span>
                    <span class="n">parent_cells_to_intersection_cells</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">equation_system</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">nonzero</span> <span class="o">=</span> <span class="n">average_weights</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">average_weights</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">average_weights</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span>
                <span class="c1"># Wrap as diagonal matrix.</span>
                <span class="n">average_mat</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_matrix</span><span class="p">(</span>
                    <span class="n">average_weights</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;average_weights&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Average apertures of the parent subdomains.</span>
                <span class="n">apertures_of_dim</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">average_mat</span> <span class="o">*</span> <span class="n">parent_cells_to_intersection_cells</span> <span class="o">*</span> <span class="n">parent_apertures</span>
                <span class="p">)</span>
                <span class="c1"># Above matrix is defined on intersections and parents. Restrict to</span>
                <span class="c1"># intersections.</span>
                <span class="n">intersection_subdomain_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">SubdomainProjections</span><span class="p">(</span>
                    <span class="n">subdomains_of_dim</span> <span class="o">+</span> <span class="n">parent_subdomains</span>
                <span class="p">)</span>
                <span class="n">apertures_of_dim</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">intersection_subdomain_projection</span><span class="o">.</span><span class="n">cell_restriction</span><span class="p">(</span>
                        <span class="n">subdomains_of_dim</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="n">apertures_of_dim</span>
                <span class="p">)</span>
                <span class="c1"># Add to total aperture.</span>
                <span class="n">apertures</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">(</span><span class="n">subdomains_of_dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">apertures_of_dim</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">apertures</span></div></div>


<div class="viewcode-block" id="ConstantFluidDensity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantFluidDensity">[docs]</a><span class="k">class</span> <span class="nc">ConstantFluidDensity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Constant fluid density.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstantFluidDensity.fluid_density"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantFluidDensity.fluid_density">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid density [kg/m^3].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.Note used in this implementation, but</span>
<span class="sd">                included for compatibility with other implementations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator for fluid density, represented as an Ad operator. The value is</span>
<span class="sd">            picked from the fluid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">density</span><span class="p">(),</span> <span class="s2">&quot;fluid_density&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FluidDensityFromPressure"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromPressure">[docs]</a><span class="k">class</span> <span class="nc">FluidDensityFromPressure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fluid density as a function of pressure.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perturbation_from_reference</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns a perturbation from reference state. Normally provided by</span>
<span class="sd">    a mixin of instance :class:`~porepy.models.VariableMixin`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FluidDensityFromPressure.fluid_compressibility"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromPressure.fluid_compressibility">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_compressibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid compressibility [1/Pa].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids. Not used in this implementation, but</span>
<span class="sd">                included for compatibility with other implementations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The constant compressibility of the fluid, represented as an Ad operator.</span>
<span class="sd">            The value is taken from the fluid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">compressibility</span><span class="p">(),</span> <span class="s2">&quot;fluid_compressibility&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FluidDensityFromPressure.fluid_density"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromPressure.fluid_density">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid density as a function of pressure.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\rho = \\rho_0 \\exp \\left[ c_p \\left(p - p_0\\right) \\right]</span>

<span class="sd">        with :math:`\\rho_0` the reference density, :math:`p_0` the reference pressure,</span>
<span class="sd">        :math:`c_p` the compressibility and :math:`p` the pressure.</span>

<span class="sd">        The reference density and the compressibility are taken from the fluid</span>
<span class="sd">        constants, while the reference pressure is accessible by mixin; a typical</span>
<span class="sd">        implementation will provide this in a variable class.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Fluid density as a function of pressure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The reference density is taken from the fluid constants..</span>
        <span class="n">rho_ref</span> <span class="o">=</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">density</span><span class="p">(),</span> <span class="s2">&quot;reference_fluid_density&quot;</span><span class="p">)</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">rho_ref</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_exponential</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">rho</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;fluid_density&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho</span></div>

<div class="viewcode-block" id="FluidDensityFromPressure.pressure_exponential"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromPressure.pressure_exponential">[docs]</a>    <span class="k">def</span> <span class="nf">pressure_exponential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Exponential term in the fluid density as a function of pressure.</span>

<span class="sd">        Extracted as a separate method to allow for easier combination with temperature</span>
<span class="sd">        dependent fluid density.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Exponential term in the fluid density as a function of pressure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="s2">&quot;density_exponential&quot;</span><span class="p">)</span>

        <span class="c1"># Reference variables are defined in a variables class which is assumed</span>
        <span class="c1"># to be available by mixin.</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbation_from_reference</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>

        <span class="c1"># Wrap compressibility from fluid class as matrix (left multiplication with dp)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid_compressibility</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">dp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FluidDensityFromTemperature"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromTemperature">[docs]</a><span class="k">class</span> <span class="nc">FluidDensityFromTemperature</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fluid density as a function of temperature.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perturbation_from_reference</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns a perturbation from reference state. Normally provided by</span>
<span class="sd">    a mixin of instance :class:`~porepy.models.VariableMixin`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FluidDensityFromTemperature.fluid_density"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromTemperature.fluid_density">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid density as a function of temperature.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\rho = \\rho_0 \\exp \\left[-c_T\\left(T - T_0\\right) \\right]</span>

<span class="sd">        with :math:`\\rho_0` the reference density, :math:`T_0` the reference</span>
<span class="sd">        temperature, :math:`c_T` the thermal expansion and :math:`T` the pressure.</span>

<span class="sd">        The reference density and the thermal expansion are taken from the fluid</span>
<span class="sd">        constants, while the reference temperature is accessible by mixin; a typical</span>
<span class="sd">        implementation will provide this in a variable class.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Fluid density as a function of temperature.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The reference density is taken from the fluid constants..</span>
        <span class="n">rho_ref</span> <span class="o">=</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">density</span><span class="p">(),</span> <span class="s2">&quot;reference_fluid_density&quot;</span><span class="p">)</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">rho_ref</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_exponential</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">rho</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;fluid_density&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho</span></div>

<div class="viewcode-block" id="FluidDensityFromTemperature.temperature_exponential"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromTemperature.temperature_exponential">[docs]</a>    <span class="k">def</span> <span class="nf">temperature_exponential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Exponential term in the fluid density as a function of pressure.</span>

<span class="sd">        Extracted as a separate method to allow for easier combination with temperature</span>
<span class="sd">        dependent fluid density.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Exponential term in the fluid density as a function of pressure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="s2">&quot;density_exponential&quot;</span><span class="p">)</span>

        <span class="c1"># Reference variables are defined in a variables class which is assumed</span>
        <span class="c1"># to be available by mixin.</span>
        <span class="n">dtemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbation_from_reference</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">Scalar</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">thermal_expansion</span><span class="p">()</span> <span class="o">*</span> <span class="n">dtemp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FluidDensityFromPressureAndTemperature"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromPressureAndTemperature">[docs]</a><span class="k">class</span> <span class="nc">FluidDensityFromPressureAndTemperature</span><span class="p">(</span>
    <span class="n">FluidDensityFromPressure</span><span class="p">,</span> <span class="n">FluidDensityFromTemperature</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fluid density which is a function of pressure and temperature.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perturbation_from_reference</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns a perturbation from reference state. Normally provided by</span>
<span class="sd">    a mixin of instance :class:`~porepy.models.VariableMixin`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FluidDensityFromPressureAndTemperature.fluid_density"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidDensityFromPressureAndTemperature.fluid_density">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid density as a function of pressure and temperature.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\rho = \\rho_0 \\exp \\left[ c_p \\left(p - p_0\\right)</span>
<span class="sd">            - c_T\\left(T - T_0\\right) \\right]</span>

<span class="sd">        with :math:`\\rho_0` the reference density, :math:`p_0` the reference pressure,</span>
<span class="sd">        :math:`c_p` the compressibility, :math:`p` the pressure, :math:`T` the</span>
<span class="sd">        temperature, :math:`T_0` the reference temperature, and :math:`c_T` the thermal</span>
<span class="sd">        expansion coefficient.</span>

<span class="sd">        The reference density, the compressibility and the thermal expansion coefficient</span>
<span class="sd">        are all taken from the fluid constants, while the reference pressure and</span>
<span class="sd">        temperature are accessible by mixin; a typical implementation will provide this</span>
<span class="sd">        in a variable class.</span>

<span class="sd">          Parameters:</span>
<span class="sd">              subdomains: List of subdomain grids.</span>

<span class="sd">          Returns:</span>
<span class="sd">              Fluid density as a function of pressure and temperature.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rho_ref</span> <span class="o">=</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">density</span><span class="p">(),</span> <span class="s2">&quot;reference_fluid_density&quot;</span><span class="p">)</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rho_ref</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_exponential</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_exponential</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">rho</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;fluid_density_from_pressure_and_temperature&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho</span></div></div>


<div class="viewcode-block" id="FluidMobility"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidMobility">[docs]</a><span class="k">class</span> <span class="nc">FluidMobility</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for fluid mobility and its discretization in flow problems.&quot;&quot;&quot;</span>

    <span class="n">fluid_viscosity</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns the fluid viscosity. Normally provided by a mixin of</span>
<span class="sd">    instance :class:`~porepy.models.VariableMixin`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mobility_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword for the discretization of the mobility. Normally provided by a mixin of</span>
<span class="sd">    instance :class:`~porepy.models.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FluidMobility.mobility"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidMobility.mobility">[docs]</a>    <span class="k">def</span> <span class="nf">mobility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Mobility of the fluid flux.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the mobility.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid_viscosity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span></div>

<div class="viewcode-block" id="FluidMobility.mobility_discretization"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidMobility.mobility_discretization">[docs]</a>    <span class="k">def</span> <span class="nf">mobility_discretization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">UpwindAd</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discretization of the fluid mobility factor.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Discretization of the fluid mobility.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">UpwindAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mobility_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span></div>

<div class="viewcode-block" id="FluidMobility.interface_mobility_discretization"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FluidMobility.interface_mobility_discretization">[docs]</a>    <span class="k">def</span> <span class="nf">interface_mobility_discretization</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">UpwindCouplingAd</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discretization of the interface mobility.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interface grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Discretization for the interface mobility.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">UpwindCouplingAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mobility_keyword</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConstantViscosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantViscosity">[docs]</a><span class="k">class</span> <span class="nc">ConstantViscosity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Constant viscosity.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstantViscosity.fluid_viscosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantViscosity.fluid_viscosity">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid viscosity [Pa s].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomain grids. Not used in this implementation, but</span>
<span class="sd">                included for compatibility with other implementations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator for fluid viscosity, represented as an Ad operator. The value is</span>
<span class="sd">            picked from the fluid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span><span class="p">(),</span> <span class="s2">&quot;viscosity&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConstantPermeability"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantPermeability">[docs]</a><span class="k">class</span> <span class="nc">ConstantPermeability</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A spatially homogeneous permeability field.&quot;&quot;&quot;</span>

    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstantPermeability.permeability"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantPermeability.permeability">[docs]</a>    <span class="k">def</span> <span class="nf">permeability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Permeability [m^2].</span>

<span class="sd">        The permeability is quantity which enters the discretized equations in a form</span>
<span class="sd">        that cannot be differentiated by Ad (this is at least true for a subset of the</span>
<span class="sd">        relevant discretizations). For this reason, the permeability is not returned as</span>
<span class="sd">        an Ad operator, but as a numpy array, to be wrapped as a SecondOrderTensor and</span>
<span class="sd">        passed as a discretization parameter.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomain: Subdomain where the permeability is defined. Should be of length</span>
<span class="sd">                1; the list format is used for compatibility with similar methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise permeability tensor. The value is picked from the solid constants.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If more than one subdomain is provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one subdomain is allowed.&quot;</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">subdomains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_cells</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">permeability</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConstantPermeability.normal_permeability"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantPermeability.normal_permeability">[docs]</a>    <span class="k">def</span> <span class="nf">normal_permeability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Normal permeability [m^2].</span>

<span class="sd">        Contrary to the permeability, the normal permeability typically enters into the</span>
<span class="sd">        discrete equations in a form that can be differentiated by Ad. For this reason,</span>
<span class="sd">        the normal permeability is returned as an Ad operator.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interface grids. Not used in this implementation, but</span>
<span class="sd">                included for compatibility with other implementations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Scalar normal permeability on the interfaces between subdomains, represented</span>
<span class="sd">            as an Ad operator. The value is picked from the solid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">normal_permeability</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="CubicLawPermeability"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.CubicLawPermeability">[docs]</a><span class="k">class</span> <span class="nc">CubicLawPermeability</span><span class="p">(</span><span class="n">ConstantPermeability</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cubic law permeability for fractures and intersections.&quot;&quot;&quot;</span>

    <span class="n">equation_system</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">EquationSystem</span>
    <span class="sd">&quot;&quot;&quot;EquationSystem object for the current model. Normally defined in a mixin class</span>
<span class="sd">    defining the solution strategy.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">specific_volume</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns the specific volume of a subdomain. Normally provided by a</span>
<span class="sd">    mixin of instance :class:`~porepy.models.constitutive_laws.DimensionReduction`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aperture</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns the aperture of a subdomain. Normally provided by a</span>
<span class="sd">    mixin of instance :class:`~porepy.models.constitutive_laws.DimensionReduction`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CubicLawPermeability.permeability"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.CubicLawPermeability.permeability">[docs]</a>    <span class="k">def</span> <span class="nf">permeability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Permeability [m^2].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomain: Subdomain where the permeability is defined. Should be of length</span>
<span class="sd">                1; the list format is used for compatibility with similar methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise permeability tensor. The value is picked from the solid constants</span>
<span class="sd">                for the matrix and computed from the fracture aperture for fractures and</span>
<span class="sd">                intersections.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If more than one subdomain is provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one subdomain is allowed.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subdomains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">permeability</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>

        <span class="c1"># Fracture or intersection</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">aperture</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">12</span>
        <span class="c1"># Scale by specific volume</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="p">(</span><span class="n">perm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">specific_volume</span><span class="p">(</span><span class="n">subdomains</span><span class="p">))</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation_system</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perm</span></div></div>


<div class="viewcode-block" id="DarcysLaw"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DarcysLaw">[docs]</a><span class="k">class</span> <span class="nc">DarcysLaw</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class could be refactored to reuse for other diffusive fluxes, such as</span>
<span class="sd">    heat conduction. It&#39;s somewhat cumbersome, though, since potential, discretization,</span>
<span class="sd">    and boundary conditions all need to be passed around.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subdomains_to_interfaces</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from subdomains to the adjacent interfaces. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_to_subdomains</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from interfaces to the adjacent subdomains. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Pressure variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.VariablesSinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interface_darcy_flux</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Darcy flux variables on interfaces. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.VariablesSinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdg</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">MixedDimensionalGrid</span>
    <span class="sd">&quot;&quot;&quot;Mixed dimensional grid for the current model. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bc_values_darcy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Darcy flux boundary conditions. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.BoundaryConditionsSinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal_permeability</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Normal permeability. Normally defined in a mixin instance of :</span>
<span class="sd">    class:`~porepy.models.constitutive_laws.ConstantPermeability`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">darcy_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the Darcy flux discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.SolutionStrategySinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">GridLike</span><span class="p">],</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Basis for the local coordinate system. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">internal_boundary_normal_to_outwards</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">int</span><span class="p">],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Switch interface normal vectors to point outwards from the subdomain. Normally</span>
<span class="sd">    set by a mixin instance of :class:`porepy.models.geometry.ModelGeometry`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrap_grid_attribute</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">GridLike</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Wrap grid attributes as Ad operators. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outwards_internal_boundary_normals</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Outwards normal vectors on internal boundaries. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">specific_volume</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Specific volume. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.DimensionReduction` or a subclass thereof.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aperture</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Aperture. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.DimensionReduction` or a subclass thereof.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DarcysLaw.pressure_trace"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DarcysLaw.pressure_trace">[docs]</a>    <span class="k">def</span> <span class="nf">pressure_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pressure on the subdomain boundaries.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the pressure is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pressure on the subdomain boundaries. Parsing the operator will return a</span>
<span class="sd">            face-wise array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">discr</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MpfaAd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">darcy_flux_discretization</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">p</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">pressure_trace</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">discr</span><span class="o">.</span><span class="n">bound_pressure_cell</span> <span class="o">*</span> <span class="n">p</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_pressure_face</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">projection</span><span class="o">.</span><span class="n">mortar_to_primary_int</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_darcy_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_pressure_face</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_values_darcy</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">vector_source</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_source</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;fluid&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pressure_trace</span></div>

<div class="viewcode-block" id="DarcysLaw.darcy_flux"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DarcysLaw.darcy_flux">[docs]</a>    <span class="k">def</span> <span class="nf">darcy_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discretization of Darcy&#39;s law.</span>

<span class="sd">        Note:</span>
<span class="sd">            The fluid mobility is not included in the Darcy flux. This is because we</span>
<span class="sd">            discretize it with an upstream scheme. This means that the fluid mobility</span>
<span class="sd">            may have to be included when using the flux in a transport equation.</span>
<span class="sd">            The units of the Darcy flux are [m^2 Pa / s].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the Darcy flux is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Face-wise Darcy flux in cubic meters per second.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">discr</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MpfaAd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">darcy_flux_discretization</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">flux</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">discr</span><span class="o">.</span><span class="n">flux</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_flux</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bc_values_darcy</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">projection</span><span class="o">.</span><span class="n">mortar_to_primary_int</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_darcy_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">vector_source</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_source</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;fluid&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Darcy_flux&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flux</span></div>

<div class="viewcode-block" id="DarcysLaw.interface_darcy_flux_equation"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DarcysLaw.interface_darcy_flux_equation">[docs]</a>    <span class="k">def</span> <span class="nf">interface_darcy_flux_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Darcy flux on interfaces.</span>

<span class="sd">        The units of the Darcy flux are [m^2 Pa / s], see note in :meth:`darcy_flux`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interface grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the Darcy flux equation on the interfaces.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces_to_subdomains</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>

        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Ignore mypy complaint about unexpected keyword arguments.</span>
        <span class="n">cell_volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_grid_attribute</span><span class="p">(</span>
            <span class="n">interfaces</span><span class="p">,</span> <span class="s2">&quot;cell_volumes&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># type: ignore[call-arg]</span>
        <span class="p">)</span>
        <span class="n">specific_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specific_volume</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Gradient operator in the normal direction. The collapsed distance is</span>
        <span class="c1"># :math:`\frac{a}{2}` on either side of the fracture.</span>
        <span class="c1"># We assume here that :meth:`apeture` is implemented to give a meaningful value</span>
        <span class="c1"># also for subdomains of co-dimension &gt; 1.</span>
        <span class="n">normal_gradient</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">secondary_to_mortar_avg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Project the two pressures to the interface and multiply with the normal</span>
        <span class="c1"># diffusivity.</span>
        <span class="c1"># The cell volumes are scaled in two stages:</span>
        <span class="c1"># The term cell_volumes carries the volume of the cells in the mortar grids,</span>
        <span class="c1"># while the volume scaling from reduced dimensions is picked from the</span>
        <span class="c1"># specific volumes of the higher dimension (variable `specific_volume`)</span>
        <span class="c1"># and projected to the interface via a trace operator.</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_darcy_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">cell_volumes</span>
            <span class="o">*</span> <span class="n">normal_gradient</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal_permeability</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">projection</span><span class="o">.</span><span class="n">primary_to_mortar_avg</span> <span class="o">*</span> <span class="n">trace</span><span class="o">.</span><span class="n">trace</span> <span class="o">*</span> <span class="n">specific_volume</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">projection</span><span class="o">.</span><span class="n">primary_to_mortar_avg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_trace</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">projection</span><span class="o">.</span><span class="n">secondary_to_mortar_avg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_vector_source</span><span class="p">(</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;fluid&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">eq</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;interface_darcy_flux_equation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eq</span></div>

<div class="viewcode-block" id="DarcysLaw.darcy_flux_discretization"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DarcysLaw.darcy_flux_discretization">[docs]</a>    <span class="k">def</span> <span class="nf">darcy_flux_discretization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MpfaAd</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discretization object for the Darcy flux term.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the Darcy flux is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Discretization of the Darcy flux.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: The ad.Discretizations may be purged altogether. Their current function</span>
        <span class="c1"># is very similar to the ad.Geometry in that both basically wrap numpy/scipy</span>
        <span class="c1"># arrays in ad arrays and collect them in a block matrix. This similarity could</span>
        <span class="c1"># possibly be exploited. Revisit at some point.</span>
        <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MpfaAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darcy_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span></div>

<div class="viewcode-block" id="DarcysLaw.vector_source"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DarcysLaw.vector_source">[docs]</a>    <span class="k">def</span> <span class="nf">vector_source</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">grids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">material</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Vector source term. Represents gravity effects.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            grids: List of subdomain or interface grids where the vector source is</span>
<span class="sd">                defined.</span>
<span class="sd">            material: Name of the material. Could be either &quot;fluid&quot; or &quot;solid&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise nd-vector source term operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;m*s^-2&quot;</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">num_cells</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grids</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_array</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;zero_vector_source&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">source</span></div>

<div class="viewcode-block" id="DarcysLaw.interface_vector_source"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.DarcysLaw.interface_vector_source">[docs]</a>    <span class="k">def</span> <span class="nf">interface_vector_source</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">],</span> <span class="n">material</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interface vector source term.</span>

<span class="sd">        The term is the dot product of unit normals and vector source values.</span>
<span class="sd">        Normalization is needed to balance the integration done in the interface flux</span>
<span class="sd">        law.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interfaces where the vector source is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise vector source term.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Account for sign of boundary face normals.</span>
        <span class="c1"># No scaling with interface cell volumes.</span>
        <span class="n">normals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outwards_internal_boundary_normals</span><span class="p">(</span>
            <span class="n">interfaces</span><span class="p">,</span> <span class="n">unitary</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># type: ignore[call-arg]</span>
        <span class="p">)</span>
        <span class="c1"># Make dot product with vector source in two steps. First element-wise product.</span>
        <span class="n">element_product</span> <span class="o">=</span> <span class="n">normals</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_source</span><span class="p">(</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">)</span>
        <span class="c1"># Then sum over the nd dimensions.</span>
        <span class="c1"># We need to surpress mypy complaints on e being a list of integers (error code</span>
        <span class="c1"># misc, EK has no idea why mypy thinks this is actually happening) and the</span>
        <span class="c1"># standard problem with basis having keyword-only arguments.</span>
        <span class="n">nd_to_scalar_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">e</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># type: ignore[misc]</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dot_product</span> <span class="o">=</span> <span class="n">nd_to_scalar_sum</span> <span class="o">*</span> <span class="n">element_product</span>
        <span class="k">return</span> <span class="n">dot_product</span></div></div>


<div class="viewcode-block" id="ThermalExpansion"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalExpansion">[docs]</a><span class="k">class</span> <span class="nc">ThermalExpansion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Thermal expansion coefficients for the fluid and the solid.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ThermalExpansion.fluid_thermal_expansion"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalExpansion.fluid_thermal_expansion">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_thermal_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Thermal expansion of the fluid [1/K].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the thermal expansion is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Thermal expansion of the fluid, represented as an Ad operator. The value is</span>
<span class="sd">            constant for all subdomains.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">thermal_expansion</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;fluid_thermal_expansion&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThermalExpansion.solid_thermal_expansion"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalExpansion.solid_thermal_expansion">[docs]</a>    <span class="k">def</span> <span class="nf">solid_thermal_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Thermal expansion of the solid [1/K].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the thermal expansion is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Thermal expansion of the fluid, represented as an Ad operator. The value is</span>
<span class="sd">            constant for all subdomains.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">thermal_expansion</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;solid_thermal_expansion&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ThermalConductivityLTE"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalConductivityLTE">[docs]</a><span class="k">class</span> <span class="nc">ThermalConductivityLTE</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Thermal conductivity in the local thermal equilibrium approximation.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">porosity</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Porosity of the rock. Normally provided by a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.ConstantPorosity` or a subclass thereof.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reference_porosity</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Reference porosity of the rock. Normally provided by a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.PoroMechanicsPorosity`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">equation_system</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">EquationSystem</span>
    <span class="sd">&quot;&quot;&quot;EquationSystem object for the current model. Normally defined in a mixin class</span>
<span class="sd">    defining the solution strategy.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_to_subdomains</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from interfaces to the adjacent subdomains. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ThermalConductivityLTE.fluid_thermal_conductivity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalConductivityLTE.fluid_thermal_conductivity">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_thermal_conductivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid thermal conductivity [W / (m K)].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            grids: List of subdomains where the thermal conductivity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Thermal conductivity of fluid. The returned operator is a scalar</span>
<span class="sd">            representing the constant thermal conductivity of the fluid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">thermal_conductivity</span><span class="p">(),</span> <span class="s2">&quot;fluid_thermal_conductivity&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThermalConductivityLTE.solid_thermal_conductivity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalConductivityLTE.solid_thermal_conductivity">[docs]</a>    <span class="k">def</span> <span class="nf">solid_thermal_conductivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Solid thermal conductivity [W / (m K)].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            grids: List of subdomains where the thermal conductivity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Thermal conductivity of fluid. The returned operator is a scalar, wrapped as</span>
<span class="sd">            an Ad operator, representing the constant thermal conductivity of the fluid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">thermal_conductivity</span><span class="p">(),</span> <span class="s2">&quot;solid_thermal_conductivity&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThermalConductivityLTE.thermal_conductivity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalConductivityLTE.thermal_conductivity">[docs]</a>    <span class="k">def</span> <span class="nf">thermal_conductivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Thermal conductivity [m^2].</span>

<span class="sd">        The thermal conductivity is computed as the porosity-weighted average of the</span>
<span class="sd">        fluid and solid thermal conductivities. In this implementation, both are</span>
<span class="sd">        considered constants, however, if the porosity changes with time, the weighting</span>
<span class="sd">        factor will also change.</span>

<span class="sd">        The thermal conductivity is quantity which enters the discretized equations in a</span>
<span class="sd">        form that cannot be differentiated by Ad (this is at least true for a subset of</span>
<span class="sd">        the relevant discretizations). For this reason, the thermal conductivity is not</span>
<span class="sd">        returned as an Ad operator, but as a numpy array, to be wrapped as a</span>
<span class="sd">        SecondOrderTensor and passed as a discretization parameter.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomain: Subdomain where the thermal conductivity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise conducivity tensor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Only one subdomain is allowed.&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">subdomains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_cells</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">porosity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phi</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation_system</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># We assume this means that the porosity includes a discretization matrix</span>
            <span class="c1"># which has not yet been computed.</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_porosity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">conductivity</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid_thermal_conductivity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">Scalar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">phi</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_thermal_conductivity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">conductivity</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation_system</span><span class="p">)</span>

        <span class="c1"># In case vals is proper operator, not a combination of Scalars and Arrays,</span>
        <span class="c1"># get the values.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Ad_array</span><span class="p">):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">val</span>

        <span class="k">return</span> <span class="n">vals</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThermalConductivityLTE.normal_thermal_conductivity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermalConductivityLTE.normal_thermal_conductivity">[docs]</a>    <span class="k">def</span> <span class="nf">normal_thermal_conductivity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Normal thermal conductivity.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interface grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing normal thermal conductivity on the interfaces.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">normal_thermal_conductivity</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;normal_thermal_conductivity&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FouriersLaw"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FouriersLaw">[docs]</a><span class="k">class</span> <span class="nc">FouriersLaw</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class could be refactored to reuse for other diffusive fluxes. It&#39;s somewhat</span>
<span class="sd">    cumbersome, though, since potential, discretization, and boundary conditions all</span>
<span class="sd">    need to be passed around. Also, gravity effects are not included, as opposed to the</span>
<span class="sd">    Darcy flux (see that class).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subdomains_to_interfaces</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from subdomains to the adjacent interfaces. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_to_subdomains</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from interfaces to the adjacent subdomains. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Temperature variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.energy_balance.VariablesEnergyBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdg</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">MixedDimensionalGrid</span>
    <span class="sd">&quot;&quot;&quot;Mixed dimensional grid for the current model. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interface_fourier_flux</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Fourier flux variable on interfaces. Normally defined in a mixin instance of</span>
<span class="sd">   :class:`~porepy.models.energy_balance.VariablesEnergyBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bc_values_fourier</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Fourier flux boundary conditions. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.BoundaryConditionsEnergyBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal_thermal_conductivity</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Conductivity on a mortar grid. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.ThermalConductivityLTE` or a subclass.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fourier_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the Fourier flux discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.SolutionStrategyEnergyBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrap_grid_attribute</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">GridLike</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Wrap grid attributes as Ad operators. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">specific_volume</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Specific volume. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.DimensionReduction` or a subclass thereof.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aperture</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Aperture. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.DimensionReduction` or a subclass thereof.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FouriersLaw.temperature_trace"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FouriersLaw.temperature_trace">[docs]</a>    <span class="k">def</span> <span class="nf">temperature_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Temperature on the subdomain boundaries.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The below implementation assumes the heat flux is discretized with a finite</span>
<span class="sd">            volume method (either Tpfa or Mpfa). Other discretizations may be possible,</span>
<span class="sd">            but would likely require a modification of this (and several other) methods.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the temperature is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Temperature on the subdomain boundaries. Parsing the operator will return a</span>
<span class="sd">            face-wise array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">discr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fourier_flux_discretization</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">temperature_trace</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">discr</span><span class="o">.</span><span class="n">bound_pressure_cell</span> <span class="o">*</span> <span class="n">t</span>  <span class="c1"># &quot;pressure&quot; is a legacy misnomer</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_pressure_face</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">projection</span><span class="o">.</span><span class="n">mortar_to_primary_int</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_fourier_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_pressure_face</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_values_fourier</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">temperature_trace</span></div>

<div class="viewcode-block" id="FouriersLaw.fourier_flux"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FouriersLaw.fourier_flux">[docs]</a>    <span class="k">def</span> <span class="nf">fourier_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discrete Fourier flux on subdomains.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The below implementation assumes the heat flux is discretized with a finite</span>
<span class="sd">            volume method (either Tpfa or Mpfa). Other discretizations may be possible,</span>
<span class="sd">            but would likely require a modification of this (and several other) methods.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the Fourier flux is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An Ad-operator representing the Fourier flux on the subdomains.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">discr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fourier_flux_discretization</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>

        <span class="c1"># As opposed to darcy_flux in :class:`DarcyFluxFV`, the gravity term is not</span>
        <span class="c1"># included here.</span>
        <span class="n">flux</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="n">discr</span><span class="o">.</span><span class="n">flux</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">(</span>
            <span class="n">subdomains</span>
        <span class="p">)</span> <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_flux</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bc_values_fourier</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">projection</span><span class="o">.</span><span class="n">mortar_to_primary_int</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_fourier_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Darcy_flux&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flux</span></div>

<div class="viewcode-block" id="FouriersLaw.interface_fourier_flux_equation"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FouriersLaw.interface_fourier_flux_equation">[docs]</a>    <span class="k">def</span> <span class="nf">interface_fourier_flux_equation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discrete Fourier flux on interfaces.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interface grids.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the Fourier flux equation on the interfaces.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces_to_subdomains</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>

        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Ignore mypy complaint about unexpected keyword arguments.</span>
        <span class="n">cell_volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_grid_attribute</span><span class="p">(</span>
            <span class="n">interfaces</span><span class="p">,</span> <span class="s2">&quot;cell_volumes&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># type: ignore[call-arg]</span>
        <span class="p">)</span>
        <span class="n">specific_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specific_volume</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Gradient operator in the normal direction. The collapsed distance is</span>
        <span class="c1"># :math:`\frac{a}{2}` on either side of the fracture.</span>
        <span class="n">normal_gradient</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">secondary_to_mortar_avg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">normal_gradient</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;normal_gradient&quot;</span><span class="p">)</span>

        <span class="c1"># Project the two temperatures to the interface and multiply with the normal</span>
        <span class="c1"># conductivity.</span>
        <span class="c1"># See comments in :meth:`interface_darcy_flux_equation` for more information on</span>
        <span class="c1"># the terms in the below equation.</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_fourier_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">cell_volumes</span>
            <span class="o">*</span> <span class="n">normal_gradient</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal_thermal_conductivity</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">projection</span><span class="o">.</span><span class="n">primary_to_mortar_avg</span> <span class="o">*</span> <span class="n">trace</span><span class="o">.</span><span class="n">trace</span> <span class="o">*</span> <span class="n">specific_volume</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">projection</span><span class="o">.</span><span class="n">primary_to_mortar_avg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_trace</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">projection</span><span class="o">.</span><span class="n">secondary_to_mortar_avg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">eq</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;interface_fourier_flux_equation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eq</span></div>

<div class="viewcode-block" id="FouriersLaw.fourier_flux_discretization"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FouriersLaw.fourier_flux_discretization">[docs]</a>    <span class="k">def</span> <span class="nf">fourier_flux_discretization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MpfaAd</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fourier flux discretization.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the Fourier flux is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Discretization object for the Fourier flux.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MpfaAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourier_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AdvectiveFlux"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.AdvectiveFlux">[docs]</a><span class="k">class</span> <span class="nc">AdvectiveFlux</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mixin class for discretizing advective fluxes.&quot;&quot;&quot;</span>

    <span class="n">subdomains_to_interfaces</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from subdomains to the adjacent interfaces. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_to_subdomains</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from interfaces to the adjacent subdomains. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdg</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">MixedDimensionalGrid</span>
    <span class="sd">&quot;&quot;&quot;Mixed dimensional grid for the current model. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">darcy_flux</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Darcy flux variables on subdomains. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.DarcysLaw`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interface_darcy_flux</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Darcy flux variables on interfaces. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.VariablesSinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdvectiveFlux.advective_flux"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.AdvectiveFlux.advective_flux">[docs]</a>    <span class="k">def</span> <span class="nf">advective_flux</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span>
        <span class="n">advected_entity</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">,</span>
        <span class="n">discr</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">UpwindAd</span><span class="p">,</span>
        <span class="n">bc_values</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">,</span>
        <span class="n">interface_flux</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;An operator represetning the advective flux on subdomains.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The implementation assumes that the advective flux is discretized using a</span>
<span class="sd">            standard upwind discretization. Other discretizations may be possible, but</span>
<span class="sd">            this has not been considered.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains.</span>
<span class="sd">            advected_entity: Operator representing the advected entity.</span>
<span class="sd">            discr: Discretization of the advective flux.</span>
<span class="sd">            bc_values: Boundary conditions for the advective flux.</span>
<span class="sd">            interface_flux: Interface flux operator/variable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the advective flux.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">darcy_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">darcy_flux</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mortar_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">flux</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">darcy_flux</span> <span class="o">*</span> <span class="p">(</span><span class="n">discr</span><span class="o">.</span><span class="n">upwind</span> <span class="o">*</span> <span class="n">advected_entity</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_transport_dir</span> <span class="o">*</span> <span class="n">darcy_flux</span> <span class="o">*</span> <span class="n">bc_values</span>
            <span class="c1"># Advective flux coming from lower-dimensional subdomains</span>
            <span class="o">-</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_transport_neu</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">mortar_projection</span><span class="o">.</span><span class="n">mortar_to_primary_int</span> <span class="o">*</span> <span class="n">interface_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">bc_values</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">flux</span></div>

<div class="viewcode-block" id="AdvectiveFlux.interface_advective_flux"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.AdvectiveFlux.interface_advective_flux">[docs]</a>    <span class="k">def</span> <span class="nf">interface_advective_flux</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">],</span>
        <span class="n">advected_entity</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">,</span>
        <span class="n">discr</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">UpwindCouplingAd</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;An operator represetning the advective flux on interfaces.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The implementation here is tailored for discretization using an upwind</span>
<span class="sd">            discretization for the advective interface flux. Other discretizaitons may</span>
<span class="sd">            be possible, but this has not been considered.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interface grids.</span>
<span class="sd">            advected_entity: Operator representing the advected entity.</span>
<span class="sd">            discr: Discretization of the advective flux.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the advective flux on the interfaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If no interfaces are given, make sure to proceed with a non-empty subdomain</span>
        <span class="c1"># list if relevant.</span>
        <span class="n">subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces_to_subdomains</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="n">mortar_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="c1"># Project the two advected entities to the interface and multiply with upstream</span>
        <span class="c1"># weights and the interface Darcy flux.</span>
        <span class="c1"># IMPLEMENTATION NOTE: If we ever implement other discretizations than upwind,</span>
        <span class="c1"># we may need to change the below definition.</span>
        <span class="n">interface_flux</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_darcy_flux</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">discr</span><span class="o">.</span><span class="n">upwind_primary</span>
            <span class="o">*</span> <span class="n">mortar_projection</span><span class="o">.</span><span class="n">primary_to_mortar_avg</span>
            <span class="o">*</span> <span class="n">trace</span><span class="o">.</span><span class="n">trace</span>
            <span class="o">*</span> <span class="n">advected_entity</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">upwind_secondary</span>
            <span class="o">*</span> <span class="n">mortar_projection</span><span class="o">.</span><span class="n">secondary_to_mortar_avg</span>
            <span class="o">*</span> <span class="n">advected_entity</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">interface_flux</span></div></div>


<div class="viewcode-block" id="SpecificHeatCapacities"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.SpecificHeatCapacities">[docs]</a><span class="k">class</span> <span class="nc">SpecificHeatCapacities</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for the specific heat capacities of the fluid and solid phases.&quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SpecificHeatCapacities.fluid_specific_heat_capacity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.SpecificHeatCapacities.fluid_specific_heat_capacity">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_specific_heat_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid specific heat capacity [J/kg/K].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains. Not used, but included for consistency with</span>
<span class="sd">                other implementations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the fluid specific heat capacity. The value is picked</span>
<span class="sd">            from the fluid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">specific_heat_capacity</span><span class="p">(),</span> <span class="s2">&quot;fluid_specific_heat_capacity&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SpecificHeatCapacities.solid_specific_heat_capacity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.SpecificHeatCapacities.solid_specific_heat_capacity">[docs]</a>    <span class="k">def</span> <span class="nf">solid_specific_heat_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Solid specific heat capacity [J/kg/K].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains. Not used, but included for consistency with</span>
<span class="sd">                other implementations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the solid specific heat capacity. The value is picked</span>
<span class="sd">            from the solid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">specific_heat_capacity</span><span class="p">(),</span> <span class="s2">&quot;solid_specific_heat_capacity&quot;</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="EnthalpyFromTemperature"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.EnthalpyFromTemperature">[docs]</a><span class="k">class</span> <span class="nc">EnthalpyFromTemperature</span><span class="p">(</span><span class="n">SpecificHeatCapacities</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for representing the ethalpy, computed from the perturbation from a</span>
<span class="sd">    reference temperature.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">temperature</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Temperature variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.energy_balance.VariablesEnergyBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">perturbation_from_reference</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns a perturbation from reference state. Normally provided by</span>
<span class="sd">    a mixin of instance :class:`~porepy.models.VariableMixin`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnthalpyFromTemperature.fluid_enthalpy"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.EnthalpyFromTemperature.fluid_enthalpy">[docs]</a>    <span class="k">def</span> <span class="nf">fluid_enthalpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fluid enthalpy [J / kg].</span>

<span class="sd">        The enthalpy is computed as a perturbation from a reference temperature as</span>
<span class="sd">        .. math::</span>
<span class="sd">            h = c_p (T - T_0)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the fluid enthalpy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid_specific_heat_capacity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">enthalpy</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbation_from_reference</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="n">enthalpy</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;fluid_enthalpy&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">enthalpy</span></div>

<div class="viewcode-block" id="EnthalpyFromTemperature.solid_enthalpy"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.EnthalpyFromTemperature.solid_enthalpy">[docs]</a>    <span class="k">def</span> <span class="nf">solid_enthalpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Solid enthalpy [J/kg].</span>

<span class="sd">        The enthalpy is computed as a perturbation from a reference temperature as</span>
<span class="sd">        .. math::</span>
<span class="sd">            h = c_p (T - T_0)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Operator representing the solid enthalpy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_specific_heat_capacity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">enthalpy</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbation_from_reference</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="n">enthalpy</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;solid_enthalpy&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">enthalpy</span></div></div>


<div class="viewcode-block" id="GravityForce"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.GravityForce">[docs]</a><span class="k">class</span> <span class="nc">GravityForce</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Gravity force.</span>

<span class="sd">    The gravity force is defined as the product of the fluid density and the gravity</span>
<span class="sd">    vector:</span>

<span class="sd">    .. math::</span>
<span class="sd">        g = -\\rho \\mathbf{g}= -\\rho \\begin{bmatrix} 0 \\\\ 0 \\\\ G \\end{bmatrix}</span>

<span class="sd">    where :math:`\\rho` is the fluid density, and :math:`G` is the magnitude of the</span>
<span class="sd">    gravity acceleration.</span>

<span class="sd">    To be used in fluid fluxes and as body force in the force/momentum balance equation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fluid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">FluidConstants</span>
    <span class="sd">&quot;&quot;&quot;Fluid constant object that takes care of scaling of fluid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e_i</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns the unit vector in the i-th direction.</span>

<span class="sd">    Normally provided by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GravityForce.gravity_force"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.GravityForce.gravity_force">[docs]</a>    <span class="k">def</span> <span class="nf">gravity_force</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">grids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span>
        <span class="n">material</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fluid&quot;</span><span class="p">,</span> <span class="s2">&quot;solid&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Vector source term on either subdomains or interfaces.</span>

<span class="sd">        Represents gravity effects. EK: Let&#39;s discuss how to name/think about this term.</span>
<span class="sd">        Note that it appears slightly differently in a flux and a force/momentum</span>
<span class="sd">        balance.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            grids: List of subdomain or interface grids where the vector source is</span>
<span class="sd">                defined.</span>
<span class="sd">            material: Name of the material. Could be either &quot;fluid&quot; or &quot;solid&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise nd-vector source term operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">GRAVITY_ACCELERATION</span><span class="p">,</span> <span class="s2">&quot;m*s^-2&quot;</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">num_cells</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grids</span><span class="p">])</span>
        <span class="n">gravity</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_array</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gravity&quot;</span><span class="p">)</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span> <span class="o">+</span> <span class="s2">&quot;_density&quot;</span><span class="p">)(</span><span class="n">grids</span><span class="p">)</span>
        <span class="c1"># Gravity acts along the last coordinate direction (z in 3d, y in 2d)</span>

        <span class="c1"># Ignore type error, can&#39;t get mypy to understand keyword-only arguments in</span>
        <span class="c1"># mixin</span>
        <span class="n">e_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_i</span><span class="p">(</span><span class="n">grids</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">e_n</span> <span class="o">*</span> <span class="n">gravity</span>
        <span class="n">source</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;gravity_force&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">source</span></div></div>


<div class="viewcode-block" id="LinearElasticMechanicalStress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticMechanicalStress">[docs]</a><span class="k">class</span> <span class="nc">LinearElasticMechanicalStress</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Linear elastic stress tensor.</span>

<span class="sd">    To be used in mechanical problems, e.g. force balance.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stress_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the stress discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.SolutionStrategyMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bc_values_mechanics</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Mechanics boundary conditions. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.BoundaryConditionsMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">displacement</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Displacement variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.VariablesMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interface_displacement</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Displacement variable on interfaces. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.VariablesMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contact_traction</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Contact traction variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.VariablesMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subdomains_to_interfaces</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from subdomains to the adjacent interfaces. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_to_subdomains</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from interfaces to the adjacent subdomains. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">local_coordinates</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Mapping to local coordinates. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdg</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">MixedDimensionalGrid</span>
    <span class="sd">&quot;&quot;&quot;Mixed dimensional grid for the current model. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LinearElasticMechanicalStress.mechanical_stress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticMechanicalStress.mechanical_stress">[docs]</a>    <span class="k">def</span> <span class="nf">mechanical_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Linear elastic mechanical stress.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The below discretization assumes the stress is discretized with a Mpsa</span>
<span class="sd">            finite volume discretization. Other discretizations may be possible, but are</span>
<span class="sd">            not available in PorePy at the moment, and would likely require changes to</span>
<span class="sd">            this method.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains. Should be of co-dimension 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Ad operator representing the mechanical stress on grid faces of the</span>
<span class="sd">                subdomains.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">:</span>
            <span class="c1"># The mechanical stress is only defined on subdomains of co-dimension 0.</span>
            <span class="k">assert</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span>

        <span class="c1"># No need to facilitate changing of stress discretization, only one is</span>
        <span class="c1"># available at the moment.</span>
        <span class="n">discr</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MpsaAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stress_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="c1"># Fractures in the domain</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Boundary conditions on external boundaries</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_values_mechanics</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>
        <span class="c1"># The stress in the subdomanis is the sum of the stress in the subdomain,</span>
        <span class="c1"># the stress on the external boundaries, and the stress on the interfaces.</span>
        <span class="c1"># The latter is found by projecting the displacement on the interfaces to the</span>
        <span class="c1"># subdomains, and let these act as Dirichlet boundary conditions on the</span>
        <span class="c1"># subdomains.</span>
        <span class="n">stress</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">discr</span><span class="o">.</span><span class="n">stress</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_stress</span> <span class="o">*</span> <span class="n">bc</span>
            <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_stress</span>
            <span class="o">*</span> <span class="n">proj</span><span class="o">.</span><span class="n">mortar_to_primary_avg</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_displacement</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">stress</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;mechanical_stress&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stress</span></div>

<div class="viewcode-block" id="LinearElasticMechanicalStress.fracture_stress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticMechanicalStress.fracture_stress">[docs]</a>    <span class="k">def</span> <span class="nf">fracture_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fracture stress on interfaces.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interfaces where the stress is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Fracture stress operator.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any interface is not of co-dimension 1.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">interface</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Interface must be of co-dimension 1.&quot;</span><span class="p">)</span>

        <span class="c1"># Subdomains of the interfaces</span>
        <span class="n">subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces_to_subdomains</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="c1"># Isolate the fracture subdomains</span>
        <span class="n">fracture_subdomains</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span> <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Projection between all subdomains of the interfaces</span>
        <span class="n">subdomain_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">SubdomainProjections</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>
        <span class="c1"># Projection between the subdomains and the interfaces</span>
        <span class="n">mortar_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span>
        <span class="p">)</span>
        <span class="c1"># Spelled out, the stress on the interface is found by mapping the</span>
        <span class="c1"># contact traction (a primary variable) from local to global coordinates (note</span>
        <span class="c1"># the transpose), prolonging the traction from the fracture subdomains to all</span>
        <span class="c1"># subdomains (the domain of definition for the mortar projections), projecting</span>
        <span class="c1"># to the interface, and switching the sign of the traction depending on the</span>
        <span class="c1"># sign of the mortar sides.</span>
        <span class="n">traction</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mortar_projection</span><span class="o">.</span><span class="n">sign_of_mortar_sides</span>
            <span class="o">*</span> <span class="n">mortar_projection</span><span class="o">.</span><span class="n">secondary_to_mortar_int</span>
            <span class="o">*</span> <span class="n">subdomain_projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">(</span><span class="n">fracture_subdomains</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_coordinates</span><span class="p">(</span><span class="n">fracture_subdomains</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_traction</span><span class="p">(</span><span class="n">fracture_subdomains</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">traction</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;mechanical_fracture_stress&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">traction</span></div></div>


<div class="viewcode-block" id="PressureStress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PressureStress">[docs]</a><span class="k">class</span> <span class="nc">PressureStress</span><span class="p">(</span><span class="n">LinearElasticMechanicalStress</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stress tensor from pressure.</span>

<span class="sd">    To be used in poromechanical problems.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The below discretization assumes the stress is discretized with a Mpsa finite</span>
<span class="sd">        volume discretization. Other discretizations may be possible, but are not</span>
<span class="sd">        available in PorePy at the moment, and would likely require changes to this</span>
<span class="sd">        method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Pressure variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.VariablesSinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reference_pressure</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Reference pressure. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.VariablesSinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outwards_internal_boundary_normals</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Outwards normal vectors on internal boundaries. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stress_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the stress discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.SolutionStrategyMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_to_subdomains</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from interfaces to the adjacent subdomains. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdg</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">MixedDimensionalGrid</span>
    <span class="sd">&quot;&quot;&quot;Mixed dimensional grid for the current model. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">GridLike</span><span class="p">],</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Basis for the local coordinate system. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PressureStress.pressure_stress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PressureStress.pressure_stress">[docs]</a>    <span class="k">def</span> <span class="nf">pressure_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pressure contribution to stress tensor.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the stress is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pressure stress operator.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any subdomain is not of dimension `nd`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">:</span>
            <span class="c1"># The stress is only defined in matrix subdomains. The stress from fluid</span>
            <span class="c1"># pressure in fracture subdomains is handled in :meth:`fracture_stress`.</span>
            <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subdomain must be of dimension nd.&quot;</span><span class="p">)</span>

        <span class="c1"># No need to accommodate different discretizations for the stress tensor, as we</span>
        <span class="c1"># have only one.</span>
        <span class="n">discr</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">BiotAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stress_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="c1"># The stress is simply found by the grad_p operator, multiplied with the</span>
        <span class="c1"># pressure perturbation.</span>
        <span class="n">stress</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">discr</span><span class="o">.</span><span class="n">grad_p</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="c1"># The reference pressure is only defined on sd_primary, thus there is no</span>
            <span class="c1"># need for a subdomain projection.</span>
            <span class="o">-</span> <span class="n">discr</span><span class="o">.</span><span class="n">grad_p</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_pressure</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">stress</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;pressure_stress&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stress</span></div>

<div class="viewcode-block" id="PressureStress.fracture_stress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PressureStress.fracture_stress">[docs]</a>    <span class="k">def</span> <span class="nf">fracture_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fracture stress on interfaces.</span>

<span class="sd">        The fracture stress is composed of the stress from the contact traction, and</span>
<span class="sd">        the stress from the fluid pressure inside the fracture.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interfaces where the stress is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Poromechanical stress operator on matrix-fracture interfaces.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any interface is not of dimension `nd - 1`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">intf</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Interfaces must be of dimension nd - 1.&quot;</span><span class="p">)</span>

        <span class="n">traction</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fracture_stress</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracture_pressure_stress</span><span class="p">(</span>
            <span class="n">interfaces</span>
        <span class="p">)</span>
        <span class="n">traction</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;poro_mechanical_fracture_stress&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">traction</span></div>

<div class="viewcode-block" id="PressureStress.fracture_pressure_stress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PressureStress.fracture_pressure_stress">[docs]</a>    <span class="k">def</span> <span class="nf">fracture_pressure_stress</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pressure contribution to stress tensor on fracture-matrix interfaces.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            interfaces: List of interfaces where the stress is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pressure stress operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># All subdomains of the interfaces</span>
        <span class="n">subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interfaces_to_subdomains</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="n">mortar_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">)</span>

        <span class="c1"># Consistent sign of the normal vectors.</span>
        <span class="c1"># Note the unitary scaling here, we will scale the pressure with the area</span>
        <span class="c1"># of the interface (equivalently face area in the matrix subdomains) elsewhere.</span>
        <span class="n">outwards_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outwards_internal_boundary_normals</span><span class="p">(</span>
            <span class="n">interfaces</span><span class="p">,</span> <span class="n">unitary</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># type: ignore[call-arg]</span>
        <span class="p">)</span>

        <span class="c1"># Expands from cell-wise scalar to vector. Equivalent to the :math:`\mathbf{I}p`</span>
        <span class="c1"># operation.</span>
        <span class="c1"># Mypy seems to believe that sum always returns a scalar. Ignore errors.</span>
        <span class="n">scalar_to_nd</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="p">[</span>
                <span class="n">e_i</span>  <span class="c1"># type: ignore[misc]</span>
                <span class="k">for</span> <span class="n">e_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Spelled out, from the right: Project the pressure from the fracture to the</span>
        <span class="c1"># mortar, expand to an nd-vector, and multiply with the outwards normal vector.</span>
        <span class="n">stress</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">outwards_normal</span>
            <span class="o">*</span> <span class="n">scalar_to_nd</span>
            <span class="o">*</span> <span class="n">mortar_projection</span><span class="o">.</span><span class="n">secondary_to_mortar_avg</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">stress</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;fracture_pressure_stress&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stress</span></div></div>


<div class="viewcode-block" id="ThermoPressureStress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermoPressureStress">[docs]</a><span class="k">class</span> <span class="nc">ThermoPressureStress</span><span class="p">(</span><span class="n">PressureStress</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stress tensor from pressure and temperature.</span>

<span class="sd">    To be used in thermoporomechanical problems.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This class assumes both pressure and temperature stresses. To avoid having</span>
<span class="sd">        to discretize twice, the pressure stress is discretized with a Mpsa</span>
<span class="sd">        discretization, while the temperature stress computed as a scaled version of</span>
<span class="sd">        the pressure stress. If pure thermomechanical problems are to be solved, a</span>
<span class="sd">        different class must be used for the temperature stress.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">temperature</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Temperature variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.energy_balance.VariablesEnergyBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reference_temperature</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Reference temperature. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.energy_balance.VariablesEnergyBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">biot_coefficient</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Biot coefficient. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.BiotCoefficient`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bulk_modulus</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Bulk modulus. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.LinearElasticSolid`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid_thermal_expansion</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Thermal expansion coefficient. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.ThermalExpansion`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stress_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the stress discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.SolutionStrategyMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ThermoPressureStress.thermal_stress"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermoPressureStress.thermal_stress">[docs]</a>    <span class="k">def</span> <span class="nf">thermal_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Temperature contribution to stress tensor.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the stress is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Temperature stress operator.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If any subdomain is not of dimension `nd`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subdomains must be of dimension nd - 1.&quot;</span><span class="p">)</span>

        <span class="n">discr</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">BiotAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stress_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biot_coefficient</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_thermal_expansion</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_modulus</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>

        <span class="c1"># Check that both are scalar. Else, the scaling may not be correct.</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">)</span>
        <span class="c1"># The thermal stress should be multiplied by beta and k. Divide by alpha to</span>
        <span class="c1"># cancel that factor from the discretization matrix.</span>
        <span class="n">stress</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">beta</span>
            <span class="o">*</span> <span class="n">k</span>
            <span class="o">/</span> <span class="n">alpha</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">discr</span><span class="o">.</span><span class="n">grad_p</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">discr</span><span class="o">.</span><span class="n">grad_p</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_temperature</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">stress</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;thermal_stress&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stress</span></div></div>


<div class="viewcode-block" id="ConstantSolidDensity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantSolidDensity">[docs]</a><span class="k">class</span> <span class="nc">ConstantSolidDensity</span><span class="p">:</span>

    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstantSolidDensity.solid_density"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantSolidDensity.solid_density">[docs]</a>    <span class="k">def</span> <span class="nf">solid_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Scalar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constant solid density.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the density is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Scalar operator representing the solid density. The (constant) value is</span>
<span class="sd">                picked from the solid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">density</span><span class="p">(),</span> <span class="s2">&quot;solid_density&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LinearElasticSolid"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticSolid">[docs]</a><span class="k">class</span> <span class="nc">LinearElasticSolid</span><span class="p">(</span><span class="n">LinearElasticMechanicalStress</span><span class="p">,</span> <span class="n">ConstantSolidDensity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linear elastic properties of a solid.</span>

<span class="sd">    Includes &quot;primary&quot; stiffness parameters (lame_lambda, shear_modulus) and &quot;secondary&quot;</span>
<span class="sd">    parameters (bulk_modulus, lame_mu, poisson_ratio). The latter are computed from the</span>
<span class="sd">    former. Also provides a method for computing the stiffness matrix as a</span>
<span class="sd">    FourthOrderTensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LinearElasticSolid.shear_modulus"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticSolid.shear_modulus">[docs]</a>    <span class="k">def</span> <span class="nf">shear_modulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Shear modulus [Pa].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the shear modulus is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise shear modulus operator. The value is picked from the solid</span>
<span class="sd">            constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">(),</span> <span class="s2">&quot;shear_modulus&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinearElasticSolid.lame_lambda"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticSolid.lame_lambda">[docs]</a>    <span class="k">def</span> <span class="nf">lame_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Lame&#39;s first parameter [Pa].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the shear modulus is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise Lame&#39;s first parameter operator. The value is picked from the</span>
<span class="sd">                solid constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">lame_lambda</span><span class="p">(),</span> <span class="s2">&quot;lame_lambda&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinearElasticSolid.youngs_modulus"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticSolid.youngs_modulus">[docs]</a>    <span class="k">def</span> <span class="nf">youngs_modulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Young&#39;s modulus [Pa].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the Young&#39;s modulus is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise Young&#39;s modulus in Pascal. The value is picked from the solid</span>
<span class="sd">                constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">()</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">lame_lambda</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">())</span>
            <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">lame_lambda</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;youngs_modulus&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinearElasticSolid.bulk_modulus"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticSolid.bulk_modulus">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_modulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Bulk modulus [Pa].&quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">lame_lambda</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;bulk_modulus&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinearElasticSolid.stiffness_tensor"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.LinearElasticSolid.stiffness_tensor">[docs]</a>    <span class="k">def</span> <span class="nf">stiffness_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">FourthOrderTensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stiffness tensor [Pa].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomain: Subdomain where the stiffness tensor is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise stiffness tensor in SI units.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lmbda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">lame_lambda</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">subdomain</span><span class="o">.</span><span class="n">num_cells</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">subdomain</span><span class="o">.</span><span class="n">num_cells</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">FourthOrderTensor</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FracturedSolid"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FracturedSolid">[docs]</a><span class="k">class</span> <span class="nc">FracturedSolid</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fractured rock properties.</span>

<span class="sd">    This class is intended for use with fracture deformation models.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tangential_component</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Operator giving the tangential component of vectors. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.models.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">displacement_jump</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Operator giving the displacement jump on fracture grids. Normally defined in a</span>
<span class="sd">    mixin instance of :class:`~porepy.models.models.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FracturedSolid.gap"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FracturedSolid.gap">[docs]</a>    <span class="k">def</span> <span class="nf">gap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fracture gap [m].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the gap is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise fracture gap operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">angle</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dilation_angle</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">f_norm</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">l2_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;norm_function&quot;</span>
        <span class="p">)</span>
        <span class="n">f_tan</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span> <span class="s2">&quot;tan_function&quot;</span><span class="p">)</span>
        <span class="n">shear_dilation</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="n">f_tan</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">f_norm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tangential_component</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement_jump</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_gap</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">+</span> <span class="n">shear_dilation</span>
        <span class="n">gap</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;gap_with_shear_dilation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gap</span></div>

<div class="viewcode-block" id="FracturedSolid.reference_gap"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FracturedSolid.reference_gap">[docs]</a>    <span class="k">def</span> <span class="nf">reference_gap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reference gap [m].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of fracture subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise reference gap operator [m].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">gap</span><span class="p">(),</span> <span class="s2">&quot;reference_gap&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FracturedSolid.friction_coefficient"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FracturedSolid.friction_coefficient">[docs]</a>    <span class="k">def</span> <span class="nf">friction_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Friction coefficient.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of fracture subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise friction coefficient operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">friction_coefficient</span><span class="p">(),</span>
            <span class="s2">&quot;friction_coefficient&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FracturedSolid.dilation_angle"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FracturedSolid.dilation_angle">[docs]</a>    <span class="k">def</span> <span class="nf">dilation_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dilation angle [rad].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of fracture subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise dilation angle operator [rad].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">dilation_angle</span><span class="p">(),</span> <span class="s2">&quot;dilation_angle&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FrictionBound"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FrictionBound">[docs]</a><span class="k">class</span> <span class="nc">FrictionBound</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Friction bound for fracture deformation.</span>

<span class="sd">    This class is intended for use with fracture deformation models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">normal_component</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Operator giving the normal component of vectors. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.models.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">friction_coefficient</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Friction coefficient. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.FracturedSolid`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contact_traction</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Contact traction variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.VariablesMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FrictionBound.friction_bound"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.FrictionBound.friction_bound">[docs]</a>    <span class="k">def</span> <span class="nf">friction_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Friction bound [m].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of fracture subdomains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise friction bound operator [Pa].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_n</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal_component</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_traction</span><span class="p">(</span>
            <span class="n">subdomains</span>
        <span class="p">)</span>
        <span class="n">bound</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction_coefficient</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_n</span>
        <span class="n">bound</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;friction_bound&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bound</span></div></div>


<div class="viewcode-block" id="BiotCoefficient"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.BiotCoefficient">[docs]</a><span class="k">class</span> <span class="nc">BiotCoefficient</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Biot coefficient.&quot;&quot;&quot;</span>

    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BiotCoefficient.biot_coefficient"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.BiotCoefficient.biot_coefficient">[docs]</a>    <span class="k">def</span> <span class="nf">biot_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Biot coefficient.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the Biot coefficient is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Biot coefficient operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">biot_coefficient</span><span class="p">(),</span> <span class="s2">&quot;biot_coefficient&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConstantPorosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantPorosity">[docs]</a><span class="k">class</span> <span class="nc">ConstantPorosity</span><span class="p">:</span>

    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstantPorosity.porosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ConstantPorosity.porosity">[docs]</a>    <span class="k">def</span> <span class="nf">porosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constant porosity [-].</span>

<span class="sd">        The porosity is assumed to be constant, and is defined by the solid constant</span>
<span class="sd">        object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the porosity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The porosity represented as an Ad operator. The value is constant for all</span>
<span class="sd">            subdomains.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">porosity</span><span class="p">(),</span> <span class="s2">&quot;porosity&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PoroMechanicsPorosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PoroMechanicsPorosity">[docs]</a><span class="k">class</span> <span class="nc">PoroMechanicsPorosity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Porosity for poromechanical models.</span>

<span class="sd">    Note:</span>
<span class="sd">        For legacy reasons, the discretization matrices for the</span>
<span class="sd">        :math:`\nabla \cdot \mathbf{u}` and stabilization terms include a volume</span>
<span class="sd">        integral. That factor is counteracted in :meth:`displacement_divergence` and</span>
<span class="sd">        :meth:`biot_stabilization`, respectively. This ensure that the returned</span>
<span class="sd">        operators correspond to intensive quantities and are compatible with the rest</span>
<span class="sd">        of this class. The assumption is that the porosity will be integrated over</span>
<span class="sd">        cell volumes later before entering the equation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">solid</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">SolidConstants</span>
    <span class="sd">&quot;&quot;&quot;Solid constant object that takes care of scaling of solid-related quantities.</span>
<span class="sd">    Normally, this is set by a mixin of instance</span>
<span class="sd">    :class:`~porepy.models.solution_strategy.SolutionStrategy`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nd</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Ambient dimension of the problem. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdg</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">MixedDimensionalGrid</span>
    <span class="sd">&quot;&quot;&quot;Mixed dimensional grid for the current model. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perturbation_from_reference</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns a perturbation from reference state. Normally provided by</span>
<span class="sd">    a mixin of instance :class:`~porepy.models.VariableMixin`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">biot_coefficient</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Biot coefficient. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.BiotCoefficient`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bulk_modulus</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Bulk modulus. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.LinearElasticSolid`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stress_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the stress discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.SolutionStrategyMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">darcy_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the Darcy flux discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.SolutionStrategySinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bc_values_mechanics</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Mechanics boundary conditions. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.BoundaryConditionsMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">displacement</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Displacement variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.VariablesMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interface_displacement</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Displacement variable on interfaces. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.VariablesMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MixedDimensionalVariable</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Pressure variable. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.fluid_mass_balance.VariablesSinglePhaseFlow`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subdomains_to_interfaces</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">MortarGrid</span><span class="p">]]</span>
    <span class="sd">&quot;&quot;&quot;Map from subdomains to the adjacent interfaces. Normally defined in a mixin</span>
<span class="sd">    instance of :class:`~porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrap_grid_attribute</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">GridLike</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Matrix</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Wrap grid attributes as Ad operators. Normally set by a mixin instance of</span>
<span class="sd">    :class:`porepy.models.geometry.ModelGeometry`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PoroMechanicsPorosity.reference_porosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PoroMechanicsPorosity.reference_porosity">[docs]</a>    <span class="k">def</span> <span class="nf">reference_porosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reference porosity.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the reference porosity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reference porosity operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solid</span><span class="o">.</span><span class="n">porosity</span><span class="p">(),</span> <span class="s2">&quot;reference_porosity&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PoroMechanicsPorosity.porosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PoroMechanicsPorosity.porosity">[docs]</a>    <span class="k">def</span> <span class="nf">porosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Porosity.</span>

<span class="sd">        Pressure and displacement dependent porosity in the matrix. Unitary in fractures</span>
<span class="sd">        and intersections.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the porosity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Porosity operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subdomains_nd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span> <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">]</span>
        <span class="n">subdomains_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span> <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">]</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">SubdomainProjections</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Constant unitary porosity in fractures and intersections</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">sd</span><span class="o">.</span><span class="n">num_cells</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains_lower</span><span class="p">])</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">wrap_as_ad_array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;one&quot;</span><span class="p">)</span>
        <span class="n">rho_nd</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">(</span><span class="n">subdomains_nd</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_porosity</span><span class="p">(</span>
            <span class="n">subdomains_nd</span>
        <span class="p">)</span>
        <span class="n">rho_lower</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">cell_prolongation</span><span class="p">(</span><span class="n">subdomains_lower</span><span class="p">)</span> <span class="o">*</span> <span class="n">one</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">rho_nd</span> <span class="o">+</span> <span class="n">rho_lower</span>
        <span class="n">rho</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;porosity&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho</span></div>

<div class="viewcode-block" id="PoroMechanicsPorosity.matrix_porosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PoroMechanicsPorosity.matrix_porosity">[docs]</a>    <span class="k">def</span> <span class="nf">matrix_porosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Porosity in the nd-dimensional matrix [-].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the porosity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise porosity operator [-].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subdomains must be of dimension nd.&quot;</span><span class="p">)</span>
        <span class="n">phi_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_porosity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbation_from_reference</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biot_coefficient</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">bulk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_modulus</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>

        <span class="c1"># 1/N as defined in Coussy, 2004, https://doi.org/10.1002/0470092718.</span>
        <span class="n">n_inv</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">phi_ref</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="n">bulk</span>

        <span class="c1"># Add the three contributions to the porosity.</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi_ref</span> <span class="o">+</span> <span class="n">n_inv</span> <span class="o">*</span> <span class="n">dp</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement_divergence</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="c1"># Add stabilization term. TODO: Should this be handled elsewhere?</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">biot_stabilization</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">phi</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;stabilized_matrix_porosity&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phi</span></div>

<div class="viewcode-block" id="PoroMechanicsPorosity.displacement_divergence"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PoroMechanicsPorosity.displacement_divergence">[docs]</a>    <span class="k">def</span> <span class="nf">displacement_divergence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Divergence of displacement [-].</span>

<span class="sd">        This is div(u). Note that opposed to old implementation, the temporal is not</span>
<span class="sd">        included here. Rather, it is handled by :meth:`pp.ad.dt`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the divergence is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Divergence operator accounting from contributions from interior of the</span>
<span class="sd">            domain and from internal and external boundaries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sanity check on dimension</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Displacement divergence only defined in nd.&quot;</span><span class="p">)</span>

        <span class="c1"># Obtain neighbouring interfaces</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains_to_interfaces</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Mock discretization (empty `discretize` method), used to access discretization</span>
        <span class="c1"># matrices computed by Biot discretization.</span>
        <span class="n">discr</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">DivUAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stress_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">darcy_keyword</span><span class="p">)</span>
        <span class="c1"># Projections</span>
        <span class="n">sd_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">SubdomainProjections</span><span class="p">(</span><span class="n">subdomains</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">mortar_projection</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">MortarProjections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdg</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span>
        <span class="p">)</span>
        <span class="n">bc_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_values_mechanics</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>

        <span class="c1"># Compose operator.</span>
        <span class="n">div_u_integrated</span> <span class="o">=</span> <span class="n">discr</span><span class="o">.</span><span class="n">div_u</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span>
            <span class="n">subdomains</span>
        <span class="p">)</span> <span class="o">+</span> <span class="n">discr</span><span class="o">.</span><span class="n">bound_div_u</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">bc_values</span>
            <span class="o">+</span> <span class="n">sd_projection</span><span class="o">.</span><span class="n">face_restriction</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">mortar_projection</span><span class="o">.</span><span class="n">mortar_to_primary_avg</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_displacement</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Divide by cell volumes to counteract integration.</span>
        <span class="c1"># The div_u discretization contains a volume integral. Since div u is used here</span>
        <span class="c1"># together with intensive quantities, we need to divide by cell volumes.</span>
        <span class="n">div_u</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_grid_attribute</span><span class="p">(</span>  <span class="c1"># type: ignore[call-arg]</span>
                <span class="n">subdomains</span><span class="p">,</span> <span class="s2">&quot;cell_volumes&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">div_u_integrated</span>
        <span class="p">)</span>
        <span class="n">div_u</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;div_u&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">div_u</span></div>

<div class="viewcode-block" id="PoroMechanicsPorosity.biot_stabilization"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.PoroMechanicsPorosity.biot_stabilization">[docs]</a>    <span class="k">def</span> <span class="nf">biot_stabilization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Biot stabilization term.</span>

<span class="sd">        TODO: Determine if this is the correct place to include stabilization.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the stabilization is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Biot stabilization operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sanity check on dimension</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Biot stabilization only defined in nd.&quot;</span><span class="p">)</span>

        <span class="n">discr</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">BiotStabilizationAd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darcy_keyword</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="c1"># The stabilization is based on perturbation. If pressure is used directly,</span>
        <span class="c1"># results will not match if the reference state is not zero, see</span>
        <span class="c1"># :func:`test_without_fracture` in test_poromechanics.py.</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbation_from_reference</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="n">stabilization_integrated</span> <span class="o">=</span> <span class="n">discr</span><span class="o">.</span><span class="n">stabilization</span> <span class="o">*</span> <span class="n">dp</span>

        <span class="c1"># Divide by cell volumes to counteract integration.</span>
        <span class="c1"># The stabilization discretization contains a volume integral. Since the</span>
        <span class="c1"># stabilization term is used here together with intensive quantities, we need to</span>
        <span class="c1"># divide by cell volumes.</span>
        <span class="n">stabilization</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_grid_attribute</span><span class="p">(</span>  <span class="c1"># type: ignore[call-arg]</span>
                <span class="n">subdomains</span><span class="p">,</span> <span class="s2">&quot;cell_volumes&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">stabilization_integrated</span>
        <span class="p">)</span>

        <span class="n">stabilization</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;biot_stabilization&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stabilization</span></div></div>


<div class="viewcode-block" id="ThermoPoroMechanicsPorosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermoPoroMechanicsPorosity">[docs]</a><span class="k">class</span> <span class="nc">ThermoPoroMechanicsPorosity</span><span class="p">(</span><span class="n">PoroMechanicsPorosity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add thermal effects to matrix porosity.&quot;&quot;&quot;</span>

    <span class="n">perturbation_from_reference</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Function that returns a perturbation from reference state. Normally provided by</span>
<span class="sd">    a mixin of instance :class:`~porepy.models.VariableMixin`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solid_thermal_expansion</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">]],</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Thermal expansion coefficient. Normally defined in a mixin instance of</span>
<span class="sd">    :class:`~porepy.models.constitutive_laws.ThermalExpansion`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stress_keyword</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Keyword used to identify the stress discretization. Normally set by a mixin</span>
<span class="sd">    instance of</span>
<span class="sd">    :class:`~porepy.models.momentum_balance.SolutionStrategyMomentumBalance`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ThermoPoroMechanicsPorosity.matrix_porosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermoPoroMechanicsPorosity.matrix_porosity">[docs]</a>    <span class="k">def</span> <span class="nf">matrix_porosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Porosity [-].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the porosity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise porosity operator [-].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Poromechanical porosity.</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">matrix_porosity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="c1"># Subtract contribution from thermal expansion.</span>
        <span class="n">phi</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_expansion_porosity</span><span class="p">(</span>
            <span class="n">subdomains</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbation_from_reference</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">)</span>
        <span class="n">phi</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;thermo_poromechanics_porosity&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phi</span></div>

<div class="viewcode-block" id="ThermoPoroMechanicsPorosity.thermal_expansion_porosity"><a class="viewcode-back" href="../../../docsrc/porepy/porepy.models.constitutive_laws.html#porepy.models.constitutive_laws.ThermoPoroMechanicsPorosity.thermal_expansion_porosity">[docs]</a>    <span class="k">def</span> <span class="nf">thermal_expansion_porosity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subdomains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Grid</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Thermal porosity expansion [-].</span>

<span class="sd">        TODO: Discuss cf. Coussy p. 73. Not sure about the interpretation of alpha_phi.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            subdomains: List of subdomains where the porosity is defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell-wise thermal porosity expansion operator [-].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">sd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subdomains must be of dimension nd.&quot;</span><span class="p">)</span>
        <span class="n">phi_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_porosity</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_thermal_expansion</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">phi_ref</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta</span>
        <span class="n">phi</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;thermal_porosity_expansion&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phi</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 UiB Center for Modeling of Coupled Subsurface Dynamics, GNU LESSER GENERAL PUBLIC LICENSE Version 3, 29 June 2007..</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>